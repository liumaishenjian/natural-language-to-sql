<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªç„¶è¯­è¨€è½¬SQLæŸ¥è¯¢å·¥å…·</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jsTree CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/themes/default/style.min.css">
    <!-- jQuery (jsTree ä¾èµ–) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/jstree.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #64748b;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .modal-body {
            padding: 24px;
        }

        :root {
            --primary-color: #007AFF;
            --secondary-color: #5856D6;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --error-color: #FF3B30;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --background: #FBFBFD;
            --surface: #FFFFFF;
            --border: #D2D2D7;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-large: 16px;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #F2F2F7 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            /* ä¸‰åˆ—å¸ƒå±€çš„å“åº”å¼è®¾è®¡ */
            #query-tab > div:first-child {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-large);
            padding: 32px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px var(--shadow);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .query-section {
            grid-column: 1 / -1;
        }

        .query-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: var(--surface);
        }

        .query-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .button:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: var(--text-secondary);
        }

        .button.secondary:hover {
            background: #515154;
        }

        .button.success {
            background: var(--success-color);
        }

        .button.success:hover {
            background: #28A745;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            position: relative;
        }
        
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05));
            border-radius: inherit;
            pointer-events: none;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.95rem;
        }

        .status-value {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 1);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .status-value.status-success {
            background: rgba(255, 255, 255, 0.3);
            color: #E8F5E8;
            border-color: rgba(179, 255, 218, 0.3);
            box-shadow: 0 0 8px rgba(179, 255, 218, 0.2);
        }
        
        .status-value.status-warning {
            background: rgba(255, 255, 255, 0.3);
            color: #FFF8DC;
            border-color: rgba(255, 229, 179, 0.3);
            box-shadow: 0 0 8px rgba(255, 229, 179, 0.2);
        }
        
        .status-value.status-error {
            background: rgba(255, 255, 255, 0.3);
            color: #FFE4E1;
            border-color: rgba(255, 179, 186, 0.3);
            box-shadow: 0 0 8px rgba(255, 179, 186, 0.2);
        }

        .results-section {
            grid-column: 1 / -1;
            margin-top: 32px;
        }

        .sql-display {
            background: #1E1E1E;
            color: #D4D4D4;
            padding: 20px;
            border-radius: var(--radius);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.875rem;
            margin-bottom: 20px;
            overflow-x: auto;
            border: 1px solid #333;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .results-table th {
            background: #F8F9FA;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .results-table tr:hover {
            background: #F8F9FA;
        }

        .error-message {
            background: #FFF5F5;
            border: 1px solid #FEB2B2;
            border-radius: var(--radius);
            padding: 16px;
            color: #C53030;
            margin-top: 20px;
        }

        .success-message {
            background: #F0FFF4;
            border: 1px solid #9AE6B4;
            border-radius: var(--radius);
            padding: 16px;
            color: #38A169;
            margin-top: 20px;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }



        .schema-content {
            max-height: 400px;
            overflow-y: auto;
            background: #F8F9FA;
            padding: 16px;
            border-radius: var(--radius);
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }

        .example-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .example-query {
            background: #F8F9FA;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .example-query:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .format-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .format-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .format-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .config-select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
        }

        .config-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }

        /* è¡¨é€‰æ‹©å™¨æ ·å¼ */
        #tables-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            background: #fafafa;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #tables-container::-webkit-scrollbar {
            width: 6px;
        }

        #tables-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #tables-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #tables-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .table-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 6px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-item:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .table-item.selected {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        .table-item.selected:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #e3f2fd 100%);
        }

        .table-checkbox {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: var(--primary-color);
        }

        .table-info {
            flex: 1;
            min-width: 0; /* å…è®¸æ–‡æœ¬æˆªæ–­ */
        }

        .table-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .table-item.selected .table-name {
            color: var(--primary-color);
        }

        .table-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .table-item.selected .table-details {
            color: #1976d2;
        }

        .table-columns-preview {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .table-item.selected .table-columns-preview {
            color: #1565c0;
        }

        /* é€‰ä¸­æ•°é‡æ˜¾ç¤º */
        #selected-tables-info {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f0f7ff;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        #selected-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* è¡¨é€‰æ‹©å™¨åŠ¨ç”»æ•ˆæœ */
        .table-item {
            animation: tableItemFadeIn 0.3s ease-out;
        }

        @keyframes tableItemFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* é€‰ä¸­çŠ¶æ€çš„è„‰å†²æ•ˆæœ */
        .table-item.selected {
            animation: tableItemFadeIn 0.3s ease-out, selectedPulse 2s ease-in-out infinite;
        }

        @keyframes selectedPulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
            }
            50% {
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
            }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease-out;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 900px;
            max-height: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title::before {
            content: 'ğŸ—„ï¸';
            font-size: 1.2em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        .schema-content {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            color: #333;
            border-radius: 0 0 12px 12px;
        }

        /* Navicat é£æ ¼çš„æ•°æ®åº“ç®¡ç†ç•Œé¢ */
        .schema-content {
            display: flex;
            height: 600px;
            background: #f8f9fb;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        /* å·¦ä¾§å¯¼èˆªé¢æ¿ */
        .db-navigator {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .nav-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* å³ä¾§è¯¦æƒ…é¢æ¿ */
        .db-details {
            flex: 1;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .details-header {
            padding: 16px 20px;
            background: #f8f9fb;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .details-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .details-actions {
            display: flex;
            gap: 8px;
        }

        .details-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .details-tabs {
            display: flex;
            background: #f8f9fb;
            border-bottom: 1px solid #e1e5e9;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .tab-btn:hover {
            color: #334155;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ç°ä»£åŒ–æ ‘å½¢ç»“æ„ */
        .db-tree-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            margin: 0;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            user-select: none;
            border-bottom: 1px solid #f1f5f9;
        }

        .db-tree-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .db-tree-item:last-child {
            border-radius: 0 0 6px 6px;
            border-bottom: none;
        }

        .db-tree-item:hover {
            background: #f0f3ff;
        }

        .db-tree-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .tree-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .tree-icon.database {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .tree-icon.table {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .tree-icon.column {
            background: #e8f0fe;
            color: #1565c0;
        }

        .tree-icon.primary-key {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .tree-label {
            flex: 1;
            font-weight: 500;
        }

        .tree-meta {
            font-size: 11px;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .db-tree-item.selected .tree-meta {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        /* å­èŠ‚ç‚¹ç¼©è¿› */
        .tree-children {
            margin-left: 16px;
            border-left: 2px solid #f1f5f9;
            padding-left: 8px;
        }

        .tree-children .db-tree-item {
            margin: 0;
            padding: 5px 12px;
        }

        .tree-children .db-tree-item:first-child {
            border-radius: 0;
        }

        .tree-children .db-tree-item:last-child {
            border-radius: 0;
        }

        /* è¡¨è¯¦æƒ…å¡ç‰‡ */
        .table-info-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e1e5e9;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-content {
            padding: 0;
            overflow: hidden;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ç°ä»£åŒ–è¡¨æ ¼ */
        .modern-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap;
            border: none;
        }

        .modern-table th {
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modern-table td {
            padding: 8px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        .modern-table tr:hover {
            background: #f8fafc;
        }

        /* æ•°æ®ç±»å‹æ ‡ç­¾ */
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .type-badge.string {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-badge.number {
            background: #dcfce7;
            color: #166534;
        }

        .type-badge.date {
            background: #fef3c7;
            color: #92400e;
        }

        /* é”®ç±»å‹æ ‡ç­¾ */
        .key-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .key-badge.primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }

        .key-badge.index {
            background: #e0e7ff;
            color: #4338ca;
        }

        /* å·¥å…·æ æŒ‰é’® */
        .toolbar-btn {
            padding: 6px 10px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            color: #374151;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-btn:hover {
            background: #f9fafb;
            border-color: #667eea;
            color: #667eea;
        }

        .toolbar-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .toolbar-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            font-weight: 600;
            color: #334155;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* æŸ¥è¯¢æ¨¡å¼åˆ‡æ¢å™¨ */
        .query-mode-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8f9fb;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .switch-label {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
        }

        .mode-toggle {
            position: relative;
            display: inline-flex;
            background: #ffffff;
            border-radius: 6px;
            padding: 2px;
            border: 1px solid #d1d5db;
        }

        .mode-option {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
            background: transparent;
            border: none;
        }

        .mode-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .mode-option:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        .mode-info {
            flex: 1;
            font-size: 11px;
            color: #64748b;
        }

        .mode-info.sql-mode {
            color: #dc2626;
        }

        .mode-info.nl-mode {
            color: #059669;
        }

        /* å¯¼èˆªæ ‡ç­¾é¡µ */
        .nav-tabs {
            display: flex;
            background: #f8f9fb;
            border-radius: 8px 8px 0 0;
            border: 1px solid #e1e5e9;
            border-bottom: none;
            margin-bottom: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-tab:first-child {
            border-radius: 8px 0 0 0;
        }

        .nav-tab:last-child {
            border-radius: 0 8px 0 0;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        .nav-tab i {
            margin-right: 6px;
        }

        /* é¡µé¢å†…å®¹ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ•°æ®åº“é…ç½®è¡¨å• */
        .db-config-form {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 0 0 8px 8px;
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .connection-status.connected {
            background: #dcfce7;
            color: #166534;
        }

        .connection-status.disconnected {
            background: #fef2f2;
            color: #dc2626;
        }

        .connection-status.testing {
            background: #fef3c7;
            color: #92400e;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fb;
            color: #64748b;
            border: 1px solid #d1d5db;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .form-help {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ - æ¨¡æ€æ¡†å†…å®¹ */
        .schema-content::-webkit-scrollbar {
            width: 8px;
        }

        .schema-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .schema-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .schema-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 95%;
                margin: 20px;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .schema-content {
                padding: 16px 20px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è‡ªç„¶è¯­è¨€è½¬SQLæŸ¥è¯¢å·¥å…·</h1>
            <p>ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„æŸ¥è¯¢éœ€æ±‚ï¼ŒAIå°†è‡ªåŠ¨ç”Ÿæˆå¹¶æ‰§è¡ŒSQLè¯­å¥</p>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾é¡µ -->
        <div class="nav-tabs">
            <button id="tab-query" class="nav-tab active" onclick="switchTabSafe(this, 'query')">
                <i class="fas fa-search"></i>
                SQLæŸ¥è¯¢
            </button>
            <button id="tab-database" class="nav-tab" onclick="switchTabSafe(this, 'database')">
                <i class="fas fa-database"></i>
                æ•°æ®åº“é…ç½®
            </button>
            <button id="tab-model" class="nav-tab" onclick="switchTabSafe(this, 'model')">
                <i class="fas fa-robot"></i>
                æ¨¡å‹é…ç½®
            </button>
        </div>

                <!-- æŸ¥è¯¢é¡µé¢ -->
        <div id="query-tab" class="tab-content active">
            <!-- ä¸‰åˆ—å¸ƒå±€ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                
                <!-- ç³»ç»ŸçŠ¶æ€ - ç²¾ç®€ç‰ˆ -->
                <div class="card status-card">
                    <div class="card-title" style="position: relative; z-index: 1;">
                        <i class="fas fa-heartbeat"></i>
                        ç³»ç»ŸçŠ¶æ€
                    </div>
                    <div id="status-content" style="position: relative; z-index: 1;">
                        <div class="status-item">
                            <span class="status-label">çŠ¶æ€</span>
                            <span class="status-value" id="init-status">æ£€æŸ¥ä¸­...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ¨¡å‹</span>
                            <span class="status-value" id="model-status">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ•°æ®åº“</span>
                            <span class="status-value" id="database-status">-</span>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ - ç²¾ç®€ç‰ˆ -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-tools"></i>
                        å¿«æ·æ“ä½œ
                    </div>
                    
                    <!-- æ¨¡å‹é…ç½®åŒºåŸŸ - ç²¾ç®€ç‰ˆ -->
                    <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <select id="backend-select" class="config-select" style="font-size: 12px; padding: 6px;">
                                <option value="ollama">Ollama</option>
                                <option value="qwen_api">é€šä¹‰åƒé—®</option>
                                <option value="gemini">Gemini</option>
                            </select>
                            <select id="model-select" class="config-select" style="font-size: 12px; padding: 6px;">
                                <option value="qwen2">qwen2</option>
                            </select>
                        </div>
                        
                        <!-- API Key è®¾ç½®åŒºåŸŸ -->
                        <div id="api-key-section" style="margin-bottom: 8px; display: none;">
                            <div style="font-size: 11px; color: #555; margin-bottom: 4px; font-weight: 500;">
                                <span id="api-key-label">API Key</span>
                                <span id="api-key-hint" style="color: #888; font-weight: normal;"></span>
                            </div>
                            <div style="position: relative;">
                                <input type="password" id="api-key-input" class="config-select" 
                                       placeholder="API Key..." style="padding-right: 30px; font-size: 12px; padding-top: 6px; padding-bottom: 6px;">
                                <button type="button" onclick="toggleApiKeyVisibility()" 
                                        style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; cursor: pointer; color: #666; font-size: 10px;">
                                    <i class="fas fa-eye" id="api-key-toggle-icon"></i>
                                </button>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px; text-align: center;">
                                <span id="api-key-link">
                                    <a href="#" target="_blank" id="api-key-url" style="color: #007AFF;">è·å–API Key</a>
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 4px;">
                            <button class="button" style="font-size: 12px; padding: 6px 12px;" onclick="reinitializeWithConfig()">
                                <i class="fas fa-sync"></i> åº”ç”¨é…ç½®
                            </button>
                            <button class="button secondary" style="font-size: 10px; padding: 6px 8px;" onclick="updateModelSelect()" title="æ‰‹åŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 8px;">
                        <button class="button secondary" onclick="showSchema()" style="font-size: 12px; padding: 8px;">
                            <i class="fas fa-database"></i> æ•°æ®åº“ç»“æ„
                        </button>
                        <button class="button secondary" onclick="showModelsInline();" style="font-size: 12px; padding: 8px;">
                            <i class="fas fa-cogs"></i> æ¨¡å‹ç®¡ç†
                        </button>
                        <button class="button success" onclick="reinitialize()" style="font-size: 12px; padding: 8px;">
                            <i class="fas fa-refresh"></i> é‡æ–°åˆå§‹åŒ–
                        </button>
                    </div>
                </div>

                <!-- ç¤ºä¾‹æŸ¥è¯¢ - ç‹¬ç«‹å¡ç‰‡ -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-lightbulb"></i>
                        ç¤ºä¾‹æŸ¥è¯¢
                    </div>
                    <div class="example-queries">
                        <div class="example-query" onclick="setQuery('æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯')">
                            æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
                        </div>
                        <div class="example-query" onclick="setQuery('ç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„äººæ•°')">
                            ç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„äººæ•°
                        </div>
                        <div class="example-query" onclick="setQuery('æŸ¥æ‰¾æœ€è¿‘ä¸€å‘¨çš„è®¢å•')">
                            æŸ¥æ‰¾æœ€è¿‘ä¸€å‘¨çš„è®¢å•
                        </div>
                        <div class="example-query" onclick="setQuery('æ˜¾ç¤ºé”€å”®é¢æœ€é«˜çš„äº§å“')">
                            æ˜¾ç¤ºé”€å”®é¢æœ€é«˜çš„äº§å“
                        </div>
                        <div class="example-query" onclick="setQuery('æŸ¥è¯¢åº“å­˜ä¸è¶³çš„å•†å“')">
                            æŸ¥è¯¢åº“å­˜ä¸è¶³çš„å•†å“
                        </div>
                        <div class="example-query" onclick="setQuery('æ˜¾ç¤ºæœˆé”€å”®è¶‹åŠ¿')">
                            æ˜¾ç¤ºæœˆé”€å”®è¶‹åŠ¿
                        </div>
                    </div>
                </div>
            </div>

        <!-- æŸ¥è¯¢åŒºåŸŸ -->
        <div class="card query-section">
            <div class="card-title">
                <i class="fas fa-search"></i>
                <span id="query-title">è‡ªç„¶è¯­è¨€æŸ¥è¯¢</span>
            </div>
            
            <!-- æŸ¥è¯¢æ¨¡å¼åˆ‡æ¢å™¨ -->
            <div class="query-mode-switch">
                <span class="switch-label">æŸ¥è¯¢æ¨¡å¼ï¼š</span>
                <div class="mode-toggle">
                    <button class="mode-option active" onclick="switchQueryMode('nl')">
                        <i class="fas fa-comments"></i> è‡ªç„¶è¯­è¨€
                    </button>
                    <button class="mode-option" onclick="switchQueryMode('sql')">
                        <i class="fas fa-code"></i> SQLæŸ¥è¯¢
                    </button>
                </div>
                <div class="mode-info nl-mode" id="mode-info">
                    ğŸ’¡ ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„æŸ¥è¯¢éœ€æ±‚ï¼ŒAIå°†è‡ªåŠ¨ç”ŸæˆSQL
                </div>
            </div>
            
            <textarea 
                id="query-input" 
                class="query-input" 
                placeholder="è¯·è¾“å…¥æ‚¨çš„æŸ¥è¯¢éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„äººæ•°ç­‰..."
            ></textarea>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                <div class="format-selector">
                    <span style="font-weight: 500; margin-right: 12px;">ç»“æœæ ¼å¼ï¼š</span>
                    <button class="format-btn active" data-format="table">è¡¨æ ¼</button>
                    <button class="format-btn" data-format="json">JSON</button>
                    <button class="format-btn" data-format="csv">CSV</button>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button id="tables-btn" class="button secondary" onclick="showTablesModal()" style="font-size: 12px; padding: 8px 12px;">
                        <i class="fas fa-table"></i>
                        <span id="tables-btn-text">é€‰æ‹©è¡¨ç»“æ„</span>
                        <span id="tables-count" style="display: none; margin-left: 4px; background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                    </button>
                    <button id="query-btn" class="button" onclick="executeQuery()">
                        <i class="fas fa-play"></i>
                        æ‰§è¡ŒæŸ¥è¯¢
                    </button>
                </div>
            </div>
        </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div id="results-section" class="card results-section hidden">
                <div class="card-title">
                    <i class="fas fa-table"></i>
                    æŸ¥è¯¢ç»“æœ
                </div>
                <div id="results-content"></div>
            </div>
        </div>

        <!-- æ•°æ®åº“é…ç½®é¡µé¢ -->
        <div id="database-tab" class="tab-content">
            <div class="db-config-form">
                <h2 style="margin: 0 0 20px 0; color: #334155;">
                    <i class="fas fa-database" style="margin-right: 8px;"></i>
                    æ•°æ®åº“è¿æ¥é…ç½®
                </h2>
                
                <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                <div id="db-connection-status" class="connection-status disconnected">
                    <i class="fas fa-times-circle"></i>
                    <span>æ•°æ®åº“æœªè¿æ¥</span>
                </div>
                
                <form id="db-config-form">
                    <div class="form-group">
                        <label class="form-label">æ•°æ®åº“ç±»å‹</label>
                        <select id="db-type" class="form-select" onchange="updateDatabaseType()">
                            <option value="mysql">MySQL</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="sqlite">SQLite</option>
                            <option value="mssql">SQL Server</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ä¸»æœºåœ°å€</label>
                            <input type="text" id="db-host" class="form-input" value="localhost" placeholder="localhost">
                            <div class="form-help">æ•°æ®åº“æœåŠ¡å™¨çš„IPåœ°å€æˆ–åŸŸå</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç«¯å£</label>
                            <input type="number" id="db-port" class="form-input" value="3306" placeholder="3306">
                            <div class="form-help">æ•°æ®åº“æœåŠ¡å™¨ç«¯å£å·</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ•°æ®åº“åç§°</label>
                        <input type="text" id="db-name" class="form-input" placeholder="è¯·è¾“å…¥æ•°æ®åº“åç§°">
                        <div class="form-help">è¦è¿æ¥çš„æ•°æ®åº“åç§°</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" id="db-username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                            <div class="form-help">æ•°æ®åº“ç™»å½•ç”¨æˆ·å</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" id="db-password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ">
                            <div class="form-help">æ•°æ®åº“ç™»å½•å¯†ç </div>
                        </div>
                    </div>
                    
                    <div id="sqlite-file-group" class="form-group" style="display: none;">
                        <label class="form-label">SQLiteæ–‡ä»¶è·¯å¾„</label>
                        <input type="text" id="db-file" class="form-input" placeholder="./database.db">
                        <div class="form-help">SQLiteæ•°æ®åº“æ–‡ä»¶çš„å®Œæ•´è·¯å¾„</div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="testDatabaseConnection()">
                            <i class="fas fa-plug"></i>
                            æµ‹è¯•è¿æ¥
                        </button>
                        <button type="button" class="btn-success" onclick="saveDatabaseConfig()">
                            <i class="fas fa-save"></i>
                            ä¿å­˜é…ç½®
                        </button>
                        <button type="button" class="btn-secondary" onclick="loadDatabaseConfig()">
                            <i class="fas fa-download"></i>
                            åŠ è½½é…ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ¨¡å‹é…ç½®é¡µé¢ -->
        <div id="model-tab" class="tab-content">
            <div class="db-config-form">
                <h2 style="margin: 0 0 20px 0; color: #334155;">
                    <i class="fas fa-robot" style="margin-right: 8px;"></i>
                    AIæ¨¡å‹é…ç½®
                </h2>
                
                <form id="model-config-form">
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹åç«¯</label>
                        <select id="model-backend" class="form-select" onchange="updateModelBackendConfig()">
                            <option value="ollama">Ollama (æœ¬åœ°æ¨¡å‹)</option>
                            <option value="qwen_api">é€šä¹‰åƒé—® (åœ¨çº¿API)</option>
                            <option value="gemini">Google Gemini (åœ¨çº¿API)</option>
                        </select>
                        <div class="form-help">é€‰æ‹©è¦ä½¿ç”¨çš„AIæ¨¡å‹åç«¯æœåŠ¡</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ¨¡å‹åç§°</label>
                            <select id="model-name" class="form-select">
                                <option value="qwen2">qwen2</option>
                            </select>
                            <div class="form-help">é€‰æ‹©å…·ä½“çš„æ¨¡å‹ç‰ˆæœ¬</div>
                        </div>
                        <div class="form-group" id="ollama-url-group">
                            <label class="form-label">OllamaæœåŠ¡åœ°å€</label>
                            <input type="text" id="ollama-url" class="form-input" value="http://localhost:11434" placeholder="http://localhost:11434">
                            <div class="form-help">OllamaæœåŠ¡è¿è¡Œçš„åœ°å€å’Œç«¯å£</div>
                        </div>
                    </div>
                    
                    <div id="api-key-config-group" class="form-group" style="display: none;">
                        <label class="form-label">
                            <span id="api-key-config-label">API Key</span>
                        </label>
                        <div style="position: relative;">
                            <input type="password" id="api-key-config" class="form-input" placeholder="è¯·è¾“å…¥API Key...">
                            <button type="button" onclick="toggleApiKeyConfigVisibility()" 
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
                                           background: none; border: none; cursor: pointer; color: #64748b;">
                                <i class="fas fa-eye" id="api-key-config-toggle-icon"></i>
                            </button>
                        </div>
                        <div class="form-help">
                            <span id="api-key-config-hint">å¯é€‰ï¼Œæœªè®¾ç½®å°†ä½¿ç”¨ç¯å¢ƒå˜é‡</span>
                            <br>
                            <a href="#" target="_blank" id="api-key-config-url" style="color: #667eea;">è·å–API Key</a>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="testModelConnection()">
                            <i class="fas fa-plug"></i>
                            æµ‹è¯•è¿æ¥
                        </button>
                        <button type="button" class="btn-success" onclick="saveModelConfig()">
                            <i class="fas fa-save"></i>
                            ä¿å­˜é…ç½®
                        </button>
                        <button type="button" class="btn-secondary" onclick="loadModelConfig()">
                            <i class="fas fa-download"></i>
                            åŠ è½½é…ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="schema-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ•°æ®åº“ç»“æ„</h3>
                <button class="close-btn" onclick="closeModal('schema-modal')">Ã—</button>
            </div>
            <div id="schema-content" class="schema-content">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>



    <script>
        console.log('=== JavaScriptæ–‡ä»¶å·²åŠ è½½ ===');
        
        // å…¨å±€å˜é‡ï¼šå½“å‰æŸ¥è¯¢æ¨¡å¼
        let currentQueryMode = 'nl'; // 'nl' = è‡ªç„¶è¯­è¨€, 'sql' = SQLæŸ¥è¯¢

        // å®‰å…¨çš„æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
        function switchTabSafe(clickedButton, tabName) {
            console.log('å®‰å…¨åˆ‡æ¢æ ‡ç­¾é¡µ:', tabName);
            console.log('ç‚¹å‡»çš„æŒ‰é’®:', clickedButton);
            
            try {
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                const queryBtn = document.getElementById('tab-query');
                const databaseBtn = document.getElementById('tab-database');
                const modelBtn = document.getElementById('tab-model');
                
                if (queryBtn) queryBtn.classList.remove('active');
                if (databaseBtn) databaseBtn.classList.remove('active');
                if (modelBtn) modelBtn.classList.remove('active');
                
                // ç§»é™¤æ‰€æœ‰å†…å®¹çš„activeçŠ¶æ€
                const queryContent = document.getElementById('query-tab');
                const databaseContent = document.getElementById('database-tab');
                const modelContent = document.getElementById('model-tab');
                
                if (queryContent) queryContent.classList.remove('active');
                if (databaseContent) databaseContent.classList.remove('active');
                if (modelContent) modelContent.classList.remove('active');
                
                // æ¿€æ´»å½“å‰æŒ‰é’®å’Œå¯¹åº”å†…å®¹
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
                
                if (tabName === 'query' && queryContent) {
                    queryContent.classList.add('active');
                } else if (tabName === 'database' && databaseContent) {
                    databaseContent.classList.add('active');
                    // å»¶è¿ŸåŠ è½½æ•°æ®åº“é…ç½®
                    setTimeout(() => {
                        if (typeof loadDatabaseConfig === 'function') {
                            loadDatabaseConfig();
                        }
                    }, 100);
                } else if (tabName === 'model' && modelContent) {
                    modelContent.classList.add('active');
                    // å»¶è¿ŸåŠ è½½æ¨¡å‹é…ç½®
                    setTimeout(() => {
                        if (typeof loadModelConfig === 'function') {
                            loadModelConfig();
                        }
                    }, 100);
                }
                
                console.log('âœ… æ ‡ç­¾é¡µåˆ‡æ¢æˆåŠŸ:', tabName);
                
            } catch (error) {
                console.error('âŒ æ ‡ç­¾é¡µåˆ‡æ¢å¤±è´¥:', error);
            }
        }

        // æ•°æ®åº“ç±»å‹å˜åŒ–æ—¶æ›´æ–°ç«¯å£
        function updateDatabaseType() {
            const dbType = document.getElementById('db-type').value;
            const portInput = document.getElementById('db-port');
            const sqliteGroup = document.getElementById('sqlite-file-group');
            const hostGroup = document.querySelector('#db-host').parentElement.parentElement;
            
            // æ ¹æ®æ•°æ®åº“ç±»å‹è®¾ç½®é»˜è®¤ç«¯å£
            const defaultPorts = {
                'mysql': 3306,
                'postgresql': 5432,
                'sqlite': '',
                'mssql': 1433
            };
            
            if (dbType === 'sqlite') {
                sqliteGroup.style.display = 'block';
                hostGroup.style.display = 'none';
            } else {
                sqliteGroup.style.display = 'none';
                hostGroup.style.display = 'flex';
                portInput.value = defaultPorts[dbType] || '';
            }
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            const statusDiv = document.getElementById('db-connection-status');
            const testBtn = event.target;
            const originalContent = testBtn.innerHTML;
            
            // æ”¶é›†é…ç½®æ•°æ®
            const config = {
                type: document.getElementById('db-type').value,
                host: document.getElementById('db-host').value,
                port: parseInt(document.getElementById('db-port').value),
                database: document.getElementById('db-name').value,
                username: document.getElementById('db-username').value,
                password: document.getElementById('db-password').value,
                file: document.getElementById('db-file').value
            };
            
            try {
                // æ›´æ–°çŠ¶æ€
                statusDiv.className = 'connection-status testing';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>æ­£åœ¨æµ‹è¯•è¿æ¥...</span>';
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
                
                const response = await fetch('/api/test-db-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'connection-status connected';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i><span>æ•°æ®åº“è¿æ¥æˆåŠŸ</span>';
                } else {
                    statusDiv.className = 'connection-status disconnected';
                    statusDiv.innerHTML = `<i class="fas fa-times-circle"></i><span>è¿æ¥å¤±è´¥: ${data.error}</span>`;
                }
                
            } catch (error) {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.innerHTML = `<i class="fas fa-times-circle"></i><span>è¿æ¥é”™è¯¯: ${error.message}</span>`;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalContent;
            }
        }

        // ä¿å­˜æ•°æ®åº“é…ç½®
        async function saveDatabaseConfig() {
            const config = {
                type: document.getElementById('db-type').value,
                host: document.getElementById('db-host').value,
                port: parseInt(document.getElementById('db-port').value),
                database: document.getElementById('db-name').value,
                username: document.getElementById('db-username').value,
                password: document.getElementById('db-password').value,
                file: document.getElementById('db-file').value
            };
            
            try {
                const response = await fetch('/api/save-db-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ•°æ®åº“é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
                
            } catch (error) {
                alert('ä¿å­˜é”™è¯¯: ' + error.message);
            }
        }

        // åŠ è½½æ•°æ®åº“é…ç½®
        async function loadDatabaseConfig() {
            try {
                const response = await fetch('/api/get-db-config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    document.getElementById('db-type').value = config.type || 'mysql';
                    document.getElementById('db-host').value = config.host || 'localhost';
                    document.getElementById('db-port').value = config.port || 3306;
                    document.getElementById('db-name').value = config.database || '';
                    document.getElementById('db-username').value = config.username || '';
                    document.getElementById('db-password').value = config.password || '';
                    document.getElementById('db-file').value = config.file || '';
                    
                    updateDatabaseType();
                }
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®åº“é…ç½®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ¨¡å‹åç«¯é…ç½®
        function updateModelBackendConfig() {
            const backend = document.getElementById('model-backend').value;
            const modelSelect = document.getElementById('model-name');
            const ollamaGroup = document.getElementById('ollama-url-group');
            const apiKeyGroup = document.getElementById('api-key-config-group');
            const apiKeyLabel = document.getElementById('api-key-config-label');
            const apiKeyHint = document.getElementById('api-key-config-hint');
            const apiKeyUrl = document.getElementById('api-key-config-url');
            
            // æ¸…ç©ºæ¨¡å‹é€‰æ‹©å™¨
            modelSelect.innerHTML = '';
            
            // æ ¹æ®åç«¯ç±»å‹é…ç½®
            const configs = {
                'ollama': {
                    models: ['qwen2', 'llama2', 'codellama', 'mistral'],
                    showOllama: true,
                    showApiKey: false
                },
                'qwen_api': {
                    models: ['qwen-turbo', 'qwen-plus', 'qwen-max'],
                    showOllama: false,
                    showApiKey: true,
                    apiKeyLabel: 'é€šä¹‰åƒé—® API Key',
                    apiKeyHint: 'å¯é€‰ï¼Œæœªè®¾ç½®å°†ä½¿ç”¨ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY',
                    apiKeyUrl: 'https://dashscope.aliyun.com/'
                },
                'gemini': {
                    models: ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'],
                    showOllama: false,
                    showApiKey: true,
                    apiKeyLabel: 'Google Gemini API Key',
                    apiKeyHint: 'å¯é€‰ï¼Œæœªè®¾ç½®å°†ä½¿ç”¨ç¯å¢ƒå˜é‡ GEMINI_API_KEY',
                    apiKeyUrl: 'https://makersuite.google.com/app/apikey'
                }
            };
            
            const config = configs[backend];
            
            // æ·»åŠ æ¨¡å‹é€‰é¡¹
            config.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // æ˜¾ç¤º/éšè—é…ç½®ç»„
            ollamaGroup.style.display = config.showOllama ? 'block' : 'none';
            apiKeyGroup.style.display = config.showApiKey ? 'block' : 'none';
            
            // æ›´æ–°API Keyé…ç½®
            if (config.showApiKey) {
                apiKeyLabel.textContent = config.apiKeyLabel;
                apiKeyHint.textContent = config.apiKeyHint;
                apiKeyUrl.href = config.apiKeyUrl;
            }
        }

        // åˆ‡æ¢API Keyå¯è§æ€§
        function toggleApiKeyConfigVisibility() {
            const input = document.getElementById('api-key-config');
            const icon = document.getElementById('api-key-config-toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // æµ‹è¯•æ¨¡å‹è¿æ¥
        async function testModelConnection() {
            const testBtn = event.target;
            const originalContent = testBtn.innerHTML;
            
            const config = {
                backend: document.getElementById('model-backend').value,
                model: document.getElementById('model-name').value,
                ollama_url: document.getElementById('ollama-url').value,
                api_key: document.getElementById('api-key-config').value
            };
            
            try {
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
                
                const response = await fetch('/api/test-model-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ¨¡å‹è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                } else {
                    alert('è¿æ¥å¤±è´¥: ' + data.error);
                }
                
            } catch (error) {
                alert('è¿æ¥é”™è¯¯: ' + error.message);
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalContent;
            }
        }

        // ä¿å­˜æ¨¡å‹é…ç½®
        async function saveModelConfig() {
            const config = {
                backend: document.getElementById('model-backend').value,
                model: document.getElementById('model-name').value,
                ollama_url: document.getElementById('ollama-url').value,
                api_key: document.getElementById('api-key-config').value
            };
            
            try {
                const response = await fetch('/api/save-model-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ¨¡å‹é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
                
            } catch (error) {
                alert('ä¿å­˜é”™è¯¯: ' + error.message);
            }
        }

        // åŠ è½½æ¨¡å‹é…ç½®
        async function loadModelConfig() {
            try {
                const response = await fetch('/api/get-model-config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    document.getElementById('model-backend').value = config.backend || 'ollama';
                    document.getElementById('ollama-url').value = config.ollama_url || 'http://localhost:11434';
                    document.getElementById('api-key-config').value = config.api_key || '';
                    
                    updateModelBackendConfig();
                    
                    if (config.model) {
                        document.getElementById('model-name').value = config.model;
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹é…ç½®å¤±è´¥:', error);
            }
        }

                // åˆ‡æ¢æŸ¥è¯¢æ¨¡å¼
        function switchQueryMode(mode) {
            currentQueryMode = mode;
            
            // ç§»é™¤æ‰€æœ‰æ¨¡å¼æŒ‰é’®çš„activeçŠ¶æ€
            const allModeButtons = document.querySelectorAll('.mode-option');
            allModeButtons.forEach(btn => btn.classList.remove('active'));
            
            // æ ¹æ®modeæ¿€æ´»å¯¹åº”æŒ‰é’®
            if (mode === 'nl') {
                allModeButtons[0].classList.add('active');
            } else if (mode === 'sql') {
                allModeButtons[1].classList.add('active');
            }
                
            // æ›´æ–°ç•Œé¢æ–‡æœ¬å’Œæç¤º
            const queryTitle = document.getElementById('query-title');
            const queryInput = document.getElementById('query-input');
            const modeInfo = document.getElementById('mode-info');
            const queryBtn = document.getElementById('query-btn');
            
            if (mode === 'sql') {
                queryTitle.textContent = 'SQLæŸ¥è¯¢';
                queryInput.placeholder = 'è¯·è¾“å…¥SQLæŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ï¼šSELECT * FROM users WHERE age > 25';
                modeInfo.textContent = 'âš¡ ç›´æ¥æ‰§è¡ŒSQLæŸ¥è¯¢è¯­å¥ï¼Œæ”¯æŒSELECTã€INSERTã€UPDATEã€DELETEç­‰æ“ä½œ';
                modeInfo.className = 'mode-info sql-mode';
                queryBtn.innerHTML = '<i class="fas fa-play"></i> æ‰§è¡ŒSQL';
            } else {
                queryTitle.textContent = 'è‡ªç„¶è¯­è¨€æŸ¥è¯¢';
                queryInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„æŸ¥è¯¢éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„äººæ•°ç­‰...';
                modeInfo.textContent = 'ğŸ’¡ ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„æŸ¥è¯¢éœ€æ±‚ï¼ŒAIå°†è‡ªåŠ¨ç”ŸæˆSQL';
                modeInfo.className = 'mode-info nl-mode';
                queryBtn.innerHTML = '<i class="fas fa-play"></i> æ‰§è¡ŒæŸ¥è¯¢';
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            queryInput.value = '';
            
            console.log('æŸ¥è¯¢æ¨¡å¼åˆ‡æ¢å®Œæˆ:', mode);
        }

        

        
        // åœ¨é¡µé¢å†…æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯ï¼ˆä¸ä½¿ç”¨æ¨¡æ€æ¡†ï¼‰
        async function showModelsInline() {
            console.log('=== å†…è”æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯ ===');
            
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                resultsContent.innerHTML = '<div style="text-align: center; padding: 20px;">ğŸ”„ æ­£åœ¨è·å–æ¨¡å‹ä¿¡æ¯...</div>';
                resultsSection.classList.remove('hidden');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                
                console.log('æ­£åœ¨è°ƒç”¨æ¨¡å‹API...');
                const response = await fetch('/api/models');
                const data = await response.json();
                
                console.log('æ¨¡å‹APIå“åº”:', data);
                
                if (data.success && data.models) {
                    let html = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 16px 0; color: #333;">ğŸ¤– æ¨¡å‹ç®¡ç†ä¿¡æ¯</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div><strong>åç«¯ç±»å‹:</strong> ${data.backend}</div>
                                <div><strong>å½“å‰æ¨¡å‹:</strong> ${data.current}</div>
                                <div><strong>å¯ç”¨æ¨¡å‹:</strong> ${data.models.length} ä¸ª</div>
                                <div><strong>çŠ¶æ€:</strong> âœ… æ­£å¸¸</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 16px;">ğŸ“‹ å¯ç”¨æ¨¡å‹åˆ—è¡¨</h4>
                        <div style="display: grid; gap: 8px;">
                    `;
                    
                    data.models.forEach((model, index) => {
                        const isCurrent = model === data.current;
                        html += `
                            <div style="
                                padding: 12px 16px; 
                                background: ${isCurrent ? '#e3f2fd' : '#ffffff'}; 
                                border: 1px solid ${isCurrent ? '#2196f3' : '#e0e0e0'}; 
                                border-radius: 6px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            ">
                                <span style="font-family: monospace; ${isCurrent ? 'font-weight: 600;' : ''}">${model}</span>
                                ${isCurrent ? '<span style="color: #2196f3; font-size: 12px;">â— å½“å‰ä½¿ç”¨</span>' : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    resultsContent.innerHTML = html;
                } else {
                    resultsContent.innerHTML = `
                        <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0;">âŒ è·å–æ¨¡å‹ä¿¡æ¯å¤±è´¥</h3>
                            <p>é”™è¯¯ä¿¡æ¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('è·å–æ¨¡å‹ä¿¡æ¯å¤±è´¥:', error);
                resultsContent.innerHTML = `
                    <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0;">âŒ è¿æ¥å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}</p>
                    </div>
                `;
                resultsSection.classList.remove('hidden');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        

        
        let currentFormat = 'table';

        // æ¨¡å‹é…ç½®æ˜ å°„
        const modelConfigs = {
            'ollama': ['qwen2', 'llama2', 'codellama', 'mistral'],
            'qwen_api': ['qwen-turbo', 'qwen-plus', 'qwen-max'],
            'gemini': [
                'gemini-1.5-flash', 
                'gemini-1.5-pro', 
                'gemini-pro',
                'gemini-2.5-flash-preview-05-20',
                'gemini-2.0-flash-preview-image-generation'
            ]
        };

        // API Keyé…ç½®ä¿¡æ¯
        const apiKeyConfigs = {
            'ollama': {
                show: false,
                label: 'API Key',
                url: '#',
                hint: 'æœ¬åœ°æ¨¡å‹æ— éœ€API Key'
            },
            'qwen_api': {
                show: true,
                label: 'é€šä¹‰åƒé—® API Key',
                url: 'https://dashscope.aliyun.com/',
                hint: 'å¯é€‰ï¼Œæœªè®¾ç½®å°†ä½¿ç”¨ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY'
            },
            'gemini': {
                show: true,
                label: 'Google Gemini API Key',
                url: 'https://makersuite.google.com/app/apikey',
                hint: 'å¯é€‰ï¼Œæœªè®¾ç½®å°†ä½¿ç”¨ç¯å¢ƒå˜é‡ GEMINI_API_KEY'
            }
        };

        // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
        function updateModelSelect() {
            const backendSelect = document.getElementById('backend-select');
            const modelSelect = document.getElementById('model-select');
            
            if (!backendSelect || !modelSelect) {
                console.error('âŒ æ‰¾ä¸åˆ°åç«¯æˆ–æ¨¡å‹é€‰æ‹©å™¨å…ƒç´ ');
                return;
            }
            
            const selectedBackend = backendSelect.value;
            console.log('ğŸ”„ æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨ï¼Œå½“å‰åç«¯:', selectedBackend);
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '';
            
            // æ·»åŠ å¯¹åº”åç«¯çš„æ¨¡å‹é€‰é¡¹
            const models = modelConfigs[selectedBackend] || [];
            console.log('ğŸ“‹ æ‰¾åˆ°æ¨¡å‹åˆ—è¡¨:', models);
            
            if (models.length === 0) {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹é…ç½®');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æš‚æ— å¯ç”¨æ¨¡å‹';
                modelSelect.appendChild(option);
            } else {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                    console.log('âœ… æ·»åŠ æ¨¡å‹é€‰é¡¹:', model);
                });
            }
            
            // æ›´æ–°API KeyåŒºåŸŸ
            updateApiKeySection(selectedBackend);
            console.log('âœ… æ¨¡å‹é€‰æ‹©å™¨æ›´æ–°å®Œæˆ');
        }

        // æ›´æ–°API Keyè®¾ç½®åŒºåŸŸ
        function updateApiKeySection(backend) {
            const apiKeySection = document.getElementById('api-key-section');
            const apiKeyLabel = document.getElementById('api-key-label');
            const apiKeyHint = document.getElementById('api-key-hint');
            const apiKeyUrl = document.getElementById('api-key-url');
            const apiKeyInput = document.getElementById('api-key-input');
            
            console.log('ğŸ”‘ æ›´æ–°API KeyåŒºåŸŸï¼Œåç«¯:', backend);
            
            const config = apiKeyConfigs[backend];
            
            if (!config) {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„API Keyé…ç½®');
                return;
            }
            
            if (config.show) {
                console.log('âœ… æ˜¾ç¤ºAPI KeyåŒºåŸŸ');
                apiKeySection.style.display = 'block';
                if (apiKeyLabel) apiKeyLabel.textContent = config.label;
                if (apiKeyHint) apiKeyHint.textContent = `(${config.hint})`;
                if (apiKeyUrl) apiKeyUrl.href = config.url;
                if (apiKeyInput) apiKeyInput.placeholder = `è¯·è¾“å…¥${config.label}...`;
            } else {
                console.log('ğŸš« éšè—API KeyåŒºåŸŸ');
                apiKeySection.style.display = 'none';
                if (apiKeyInput) apiKeyInput.value = ''; // æ¸…ç©ºè¾“å…¥
            }
        }

        // åˆ‡æ¢API Keyå¯è§æ€§
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleIcon = document.getElementById('api-key-toggle-icon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // ä½¿ç”¨é…ç½®é‡æ–°åˆå§‹åŒ–
        async function reinitializeWithConfig() {
            const backend = document.getElementById('backend-select').value;
            const model = document.getElementById('model-select').value;
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            console.log('ä½¿ç”¨é…ç½®é‡æ–°åˆå§‹åŒ–:', { backend, model, hasApiKey: !!apiKey });
            
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜å¹¶åˆå§‹åŒ–...';
            button.disabled = true;
            
            try {
                // å…ˆä¿å­˜API Keyé…ç½®åˆ°config.iniï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (apiKey) {
                    console.log('ä¿å­˜API Keyé…ç½®...');
                    const saveResponse = await fetch('/api/save-model-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            backend: backend,
                            api_key: apiKey
                        }),
                    });
                    
                    const saveData = await saveResponse.json();
                    if (saveData.success) {
                        console.log('âœ… API Keyé…ç½®å·²ä¿å­˜åˆ°config.ini');
                    } else {
                        console.warn('âš ï¸ API Keyä¿å­˜å¤±è´¥:', saveData.error);
                    }
                }
                
                // ç„¶åæ‰§è¡Œåˆå§‹åŒ–
                const requestBody = {
                    backend: backend,
                    model: model
                };
                
                // å¦‚æœè¾“å…¥äº†API Keyï¼Œå°±å‘é€
                if (apiKey) {
                    requestBody.api_key = apiKey;
                }
                
                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`ç³»ç»Ÿå·²åˆ‡æ¢åˆ° ${backend} - ${model} å¹¶åˆå§‹åŒ–æˆåŠŸï¼é…ç½®å·²ä¿å­˜ã€‚`);
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    setTimeout(checkStatus, 1000);
                } else {
                    showError(`åˆå§‹åŒ–å¤±è´¥: ${data.message}`);
                }
                
            } catch (error) {
                console.error('é…ç½®åˆå§‹åŒ–å¤±è´¥:', error);
                showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMå†…å®¹å·²åŠ è½½ ===');
            
            // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ‰€æœ‰DOMå…ƒç´ éƒ½å®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                checkStatus();
                
                // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
                updateModelSelect();
                
                // åŠ è½½API Keyé…ç½®åˆ°å‰ç«¯
                loadApiKeyFromConfig();
                
                // åŠ è½½è¡¨ä¿¡æ¯
                loadTables();
                
                // åç«¯å˜åŒ–æ—¶æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨å’ŒåŠ è½½å¯¹åº”API Key
                const backendSelect = document.getElementById('backend-select');
                const modelSelect = document.getElementById('model-select');
                
                console.log('ğŸ” æ£€æŸ¥DOMå…ƒç´ :');
                console.log('backend-selectå­˜åœ¨:', !!backendSelect);
                console.log('model-selectå­˜åœ¨:', !!modelSelect);
                
                if (backendSelect) {
                    backendSelect.addEventListener('change', function() {
                        console.log('ğŸ”„ åç«¯é€‰æ‹©å™¨å‘ç”Ÿå˜åŒ–ï¼Œæ–°å€¼:', this.value);
                        updateModelSelect();
                        loadApiKeyFromConfig();
                    });
                    console.log('âœ… åç«¯é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°backend-selectå…ƒç´ ');
                }
                
                // æ ¼å¼é€‰æ‹©å™¨äº‹ä»¶
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentFormat = this.dataset.format;
                    });
                });
                
                console.log('=== DOMäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½® ===');
                
                // æ£€æŸ¥æ¨¡å‹ç®¡ç†æŒ‰é’®å¹¶é‡æ–°ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    const buttons = document.querySelectorAll('.button.secondary');
                    console.log('æ‰¾åˆ°çš„æŒ‰é’®æ•°é‡:', buttons.length);
                    buttons.forEach((btn, index) => {
                        console.log(`æŒ‰é’®${index}:`, btn.textContent.trim(), 'ç‚¹å‡»äº‹ä»¶:', btn.onclick);
                    });
                }, 1000);
            }, 100);
        });

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // æ›´æ–°åŸºæœ¬çŠ¶æ€
                document.getElementById('init-status').textContent = data.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
                document.getElementById('model-status').textContent = data.model || '-';
                
                // æ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼ŒåŒ…å«è¿æ¥çŠ¶æ€
                let dbStatus = data.database || '-';
                if (data.initialized && data.db_connected !== undefined) {
                    dbStatus += data.db_connected ? ' ğŸŸ¢' : ' ğŸ”´';
                }
                document.getElementById('database-status').textContent = dbStatus;
                
                // è®¾ç½®çŠ¶æ€é¢œè‰² - ä½¿ç”¨CSSç±»æ§åˆ¶æ ·å¼
                const initElement = document.getElementById('init-status');
                // å…ˆæ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
                initElement.classList.remove('status-success', 'status-warning', 'status-error');
                
                if (!data.initialized) {
                    initElement.classList.add('status-error');
                } else if (data.initialized && data.db_connected && data.ai_connected) {
                    initElement.classList.add('status-success');
                } else {
                    initElement.classList.add('status-warning');
                }
                
                // æ›´æ–°æ¨¡å‹çŠ¶æ€ï¼ŒåŒ…å«AIè¿æ¥çŠ¶æ€ - ä½¿ç”¨é«˜å¯¹æ¯”åº¦é¢œè‰²
                const modelElement = document.getElementById('model-status');
                if (data.initialized && data.ai_connected !== undefined) {
                    modelElement.textContent = (data.model || '-') + (data.ai_connected ? ' ğŸŸ¢' : ' ğŸ”´');
                    // ç§»é™¤é¢œè‰²è®¾ç½®ï¼Œè®©æ–‡å­—ä¿æŒé»˜è®¤çš„ç™½è‰²
                    modelElement.style.color = '';
                }
                
                // åŒæ­¥å‰ç«¯é…ç½®é€‰æ‹©å™¨
                if (data.backend) {
                    const backendSelect = document.getElementById('backend-select');
                    const modelSelect = document.getElementById('model-select');
                    
                    if (backendSelect.value !== data.backend) {
                        backendSelect.value = data.backend;
                        updateModelSelect();
                    }
                    
                    if (data.model && modelSelect.value !== data.model) {
                        // å¦‚æœæ¨¡å‹åˆ—è¡¨ä¸­æœ‰è¿™ä¸ªæ¨¡å‹ï¼Œå°±é€‰ä¸­å®ƒ
                        const modelOption = Array.from(modelSelect.options).find(option => option.value === data.model);
                        if (modelOption) {
                            modelSelect.value = data.model;
                        }
                    }
                }
                
            } catch (error) {
                console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
                showError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        // é‡æ–°åˆå§‹åŒ–ç³»ç»Ÿ
        async function reinitialize() {
            console.log('=== å¼€å§‹é‡æ–°åˆå§‹åŒ– ===');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆå§‹åŒ–ä¸­...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        backend: 'ollama',
                        model: 'qwen2'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('ç³»ç»Ÿé‡æ–°åˆå§‹åŒ–æˆåŠŸï¼');
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    setTimeout(checkStatus, 1000);
                } else {
                    showError(`é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${data.message}`);
                }
                
            } catch (error) {
                console.error('é‡æ–°åˆå§‹åŒ–å¤±è´¥:', error);
                showError(`é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // æ‰§è¡ŒæŸ¥è¯¢
        async function executeQuery() {
            const query = document.getElementById('query-input').value.trim();
            
            if (!query) {
                showError(currentQueryMode === 'sql' ? 'è¯·è¾“å…¥SQLæŸ¥è¯¢è¯­å¥' : 'è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }
            
            // æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
            if (currentQueryMode === 'sql') {
                await executeSqlQuery(query);
            } else {
                await executeNaturalLanguageQuery(query);
            }
        }

        // æ‰§è¡ŒSQLæŸ¥è¯¢
        async function executeSqlQuery(sqlQuery) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            const queryBtn = document.getElementById('query-btn');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                queryBtn.disabled = true;
                queryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ‰§è¡Œä¸­...';
                
                resultsContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i><br/>æ­£åœ¨æ‰§è¡ŒSQLæŸ¥è¯¢...</div>';
                resultsSection.classList.remove('hidden');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                
                const response = await fetch('/api/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sql: sqlQuery,
                        format: currentFormat
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data, sqlQuery);
                } else {
                    showError(data.error || 'SQLæ‰§è¡Œå¤±è´¥');
                }
                
            } catch (error) {
                console.error('SQLæŸ¥è¯¢é”™è¯¯:', error);
                showError('æ‰§è¡ŒSQLæŸ¥è¯¢æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            } finally {
                queryBtn.disabled = false;
                queryBtn.innerHTML = '<i class="fas fa-play"></i> æ‰§è¡ŒSQL';
            }
        }

        // æ‰§è¡Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢
        async function executeNaturalLanguageQuery(nlQuery) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            const queryBtn = document.getElementById('query-btn');
            const originalContent = queryBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            queryBtn.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æŸ¥è¯¢...</div>';
            queryBtn.disabled = true;

            try {
                // è·å–é€‰ä¸­çš„è¡¨
                const selectedTablesList = getSelectedTables();
                
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                                    body: JSON.stringify({
                    query: nlQuery,
                        format: currentFormat,
                        selected_tables: selectedTablesList
                    }),
                });

                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                showError('æŸ¥è¯¢è¯·æ±‚å¤±è´¥');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                queryBtn.innerHTML = originalContent;
                queryBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function displayResults(data) {
            console.log('=== æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ ===');
            console.log('æ”¶åˆ°çš„æ•°æ®:', JSON.stringify(data, null, 2));
            
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            
            let html = '';
            
            // æ˜¾ç¤ºç”Ÿæˆçš„SQL
            if (data.sql) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 8px; color: var(--text-secondary);">ç”Ÿæˆçš„SQLè¯­å¥ï¼š</h4>
                        <div class="sql-display">${escapeHtml(data.sql)}</div>
                    </div>
                `;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æ„åŒ–æ•°æ®
            if (data.columns && data.rows) {
                console.log('æ‰¾åˆ°ç»“æ„åŒ–æ•°æ®ï¼Œåˆ—:', data.columns, 'è¡Œæ•°:', data.rows.length);
                html += `
                    <div style="margin-bottom: 16px;">
                        <h4 style="color: var(--text-secondary);">æŸ¥è¯¢ç»“æœ (${data.row_count || data.rows.length} æ¡è®°å½•):</h4>
                    </div>
                    <div class="table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    ${data.columns.map(col => `<th>${escapeHtml(col)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows.map(row => `
                                    <tr>
                                        ${row.map(cell => `<td>${escapeHtml(String(cell || ''))}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (data.result) {
                console.log('æ²¡æœ‰ç»“æ„åŒ–æ•°æ®ï¼Œå°è¯•è§£ææ–‡æœ¬ç»“æœ');
                // å¦‚æœæ²¡æœ‰ç»“æ„åŒ–æ•°æ®ï¼Œå°è¯•è§£ææ–‡æœ¬ç»“æœ
                const parsedData = parseTextResult(data.result);
                if (parsedData) {
                    console.log('è§£æåˆ°çš„æ•°æ®:', parsedData);
                    html += `
                        <div style="margin-bottom: 16px;">
                            <h4 style="color: var(--text-secondary);">æŸ¥è¯¢ç»“æœ (${parsedData.rows.length} æ¡è®°å½•):</h4>
                        </div>
                        <div class="table-container">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        ${parsedData.columns.map(col => `<th>${escapeHtml(col)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${parsedData.rows.map(row => `
                                        <tr>
                                            ${row.map(cell => `<td>${escapeHtml(String(cell || ''))}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    console.log('æ— æ³•è§£ææ–‡æœ¬ç»“æœï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬');
                    // æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ç»“æœ
                    html += `
                        <div style="margin-bottom: 16px;">
                            <h4 style="color: var(--text-secondary);">æŸ¥è¯¢ç»“æœ:</h4>
                        </div>
                        <pre style="background: #f8f9fa; padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap;">${escapeHtml(data.result)}</pre>
                    `;
                }
            }
            
            resultsContent.innerHTML = html;
            resultsSection.classList.remove('hidden');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // è§£ææ–‡æœ¬æ ¼å¼çš„æŸ¥è¯¢ç»“æœ
        function parseTextResult(textResult) {
            try {
                console.log('å¼€å§‹è§£ææ–‡æœ¬ç»“æœ...');
                const lines = textResult.split('\n');
                let headerLine = null;
                let dataLines = [];
                let foundTable = false;
                
                // æŸ¥æ‰¾è¡¨æ ¼ç»“æ„
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // å¯»æ‰¾è¡¨æ ¼å¤´éƒ¨ï¼ˆåŒ…å« |====| çš„è¡Œï¼‰
                    if (line.includes('====') && line.includes('|')) {
                        foundTable = true;
                        // å‰ä¸€è¡Œåº”è¯¥æ˜¯åˆ—å
                        if (i > 0) {
                            headerLine = lines[i - 1];
                        }
                        // åç»­è¡Œæ˜¯æ•°æ®
                        for (let j = i + 1; j < lines.length; j++) {
                            const dataLine = lines[j].trim();
                            if (dataLine.startsWith('|') && dataLine.endsWith('|') && !dataLine.includes('====')) {
                                dataLines.push(dataLine);
                            } else if (dataLine === '' || !dataLine.startsWith('|')) {
                                break; // è¡¨æ ¼ç»“æŸ
                            }
                        }
                        break;
                    }
                }
                
                if (!foundTable || !headerLine || dataLines.length === 0) {
                    console.log('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨æ ¼ç»“æ„');
                    return null;
                }
                
                // è§£æåˆ—å
                const columns = headerLine.split('|')
                    .map(col => col.trim())
                    .filter(col => col !== '');
                
                // è§£ææ•°æ®è¡Œ
                const rows = dataLines.map(line => {
                    return line.split('|')
                        .map(cell => cell.trim())
                        .filter((cell, index) => index > 0 && index <= columns.length) // è¿‡æ»¤æ‰é¦–å°¾ç©ºå…ƒç´ 
                        .slice(0, columns.length); // ç¡®ä¿åˆ—æ•°åŒ¹é…
                });
                
                console.log('è§£æç»“æœ - åˆ—:', columns, 'è¡Œæ•°:', rows.length);
                return { columns, rows };
                
            } catch (error) {
                console.error('è§£ææ–‡æœ¬ç»“æœå¤±è´¥:', error);
                return null;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            
            let enhancedMessage = message;
            let troubleshootingTips = '';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯Geminiç›¸å…³é”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
            if (message.includes('failed to connect') || message.includes('UNAVAILABLE') || message.includes('socket is null')) {
                troubleshootingTips = `
                    <div style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <strong>ğŸ’¡ ç½‘ç»œè¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ:</strong><br/>
                        â€¢ æ£€æŸ¥ç½‘ç»œä»£ç†æˆ–é˜²ç«å¢™è®¾ç½®<br/>
                        â€¢ æš‚æ—¶å…³é—­VPNåé‡è¯•<br/>
                        â€¢ å°è¯•ä½¿ç”¨æ‰‹æœºçƒ­ç‚¹<br/>
                        â€¢ è¿è¡Œè¯Šæ–­: <code>python gemini_network_test.py</code><br/>
                        â€¢ æˆ–åˆ‡æ¢åˆ°å…¶ä»–åç«¯: <button onclick="switchToQwen()" style="margin-left: 8px; padding: 4px 8px; border: 1px solid #666; border-radius: 4px; background: white; cursor: pointer;">ä½¿ç”¨é€šä¹‰åƒé—®</button>
                    </div>
                `;
            } else if (message.includes('PERMISSION_DENIED') || message.includes('INVALID_ARGUMENT') || message.includes('API key')) {
                troubleshootingTips = `
                    <div style="margin-top: 16px; padding: 12px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px;">
                        <strong>ğŸ’¡ API Keyé—®é¢˜è§£å†³æ–¹æ¡ˆ:</strong><br/>
                        â€¢ æ£€æŸ¥API Keyæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆAIzaå¼€å¤´ï¼‰<br/>
                        â€¢ ç¡®è®¤è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³<br/>
                        â€¢ <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #1976d2;">é‡æ–°ç”ŸæˆAPI Key</a><br/>
                        â€¢ æˆ–åˆ‡æ¢åˆ°å…¶ä»–åç«¯: <button onclick="switchToQwen()" style="margin-left: 8px; padding: 4px 8px; border: 1px solid #666; border-radius: 4px; background: white; cursor: pointer;">ä½¿ç”¨é€šä¹‰åƒé—®</button>
                    </div>
                `;
            } else if (message.includes('åˆå§‹åŒ–å¤±è´¥') && message.includes('gemini')) {
                troubleshootingTips = `
                    <div style="margin-top: 16px; padding: 12px; background: #f3e5f5; border-left: 4px solid #9c27b0; border-radius: 4px;">
                        <strong>ğŸ’¡ Geminiåˆå§‹åŒ–å¤±è´¥è§£å†³æ–¹æ¡ˆ:</strong><br/>
                        â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPI Keyè®¾ç½®<br/>
                        â€¢ è¿è¡Œè¯Šæ–­å·¥å…·: <code>python gemini_network_test.py</code><br/>
                        â€¢ æŸ¥çœ‹è¯¦ç»†æ•…éšœæ’é™¤æŒ‡å—: <code>GEMINI_TROUBLESHOOTING.md</code><br/>
                        â€¢ ä¸´æ—¶ä½¿ç”¨å…¶ä»–åç«¯: <button onclick="switchToQwen()" style="margin-left: 8px; padding: 4px 8px; border: 1px solid #666; border-radius: 4px; background: white; cursor: pointer;">åˆ‡æ¢åˆ°é€šä¹‰åƒé—®</button>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                    ${escapeHtml(enhancedMessage)}
                    ${troubleshootingTips}
                </div>
            `;
            
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // è®¾ç½®æŸ¥è¯¢å†…å®¹
        function setQuery(query) {
            document.getElementById('query-input').value = query;
        }

                // Navicat é£æ ¼çš„æ•°æ®åº“ç»“æ„å±•ç¤º
        async function showSchema() {
            try {
                showModal('schema-modal');
                const schemaContent = document.getElementById('schema-content');
                schemaContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i><br/>æ­£åœ¨åŠ è½½æ•°æ®åº“ç»“æ„...</div>';
                
                const response = await fetch('/api/tables');
                const data = await response.json();
                
                if (data.success) {
                    renderNavicatUI(data.tables);
                } else {
                    schemaContent.innerHTML = `<div style="padding: 40px; text-align: center; color: #d32f2f;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px;"></i><br/>${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('schema-content').innerHTML = `<div style="padding: 40px; text-align: center; color: #d32f2f;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px;"></i><br/>è·å–æ•°æ®åº“ç»“æ„å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸²æŸ“ Navicat é£æ ¼çš„ç•Œé¢
        function renderNavicatUI(tables) {
            const schemaContent = document.getElementById('schema-content');
            
            if (tables.length === 0) {
                schemaContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <h3>æš‚æ— æ•°æ®è¡¨</h3>
                        <p>æ•°æ®åº“ä¸­æ²¡æœ‰å‘ç°ä»»ä½•è¡¨</p>
                    </div>
                `;
                return;
            }
            
            // åˆ›å»º Navicat é£æ ¼çš„å¸ƒå±€
            schemaContent.innerHTML = `
                <div class="db-navigator">
                    <div class="nav-header">
                        <i class="fas fa-database"></i>
                        <span>æ•°æ®åº“ç»“æ„</span>
                        <div style="margin-left: auto; font-size: 11px; opacity: 0.8;">${tables.length} å¼ è¡¨</div>
                    </div>
                    <div class="nav-content" id="nav-content">
                        ${renderDatabaseTree(tables)}
                    </div>
                </div>
                <div class="db-details">
                    <div class="details-header">
                        <div class="details-title">
                            <i class="fas fa-info-circle"></i>
                            <span>è¡¨è¯¦æƒ…</span>
                        </div>
                        <div class="details-actions">
                            <button class="toolbar-btn" onclick="refreshSchema()">
                                <i class="fas fa-sync-alt"></i>
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="details-content" id="details-content">
                        <div class="empty-state">
                            <i class="fas fa-mouse-pointer"></i>
                            <h3>é€‰æ‹©ä¸€ä¸ªè¡¨</h3>
                            <p>ç‚¹å‡»å·¦ä¾§çš„è¡¨åæ¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“æ•°æ®åº“æ ‘å½¢ç»“æ„
        function renderDatabaseTree(tables) {
            let html = `
                <div class="db-tree-item selected" onclick="selectDatabase()">
                    <div class="tree-icon database">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="tree-label">æ•°æ®åº“</div>
                    <div class="tree-meta">${tables.length}</div>
                </div>
                <div class="tree-children">
            `;
            
            tables.forEach(table => {
                html += `
                    <div class="db-tree-item" onclick="selectTable('${table.name}')">
                        <div class="tree-icon table">
                            <i class="fas fa-table"></i>
                        </div>
                        <div class="tree-label">${table.name}</div>
                        <div class="tree-meta">${table.rows || 0}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // é€‰æ‹©æ•°æ®åº“
        function selectDatabase() {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.db-tree-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector('.db-tree-item').classList.add('selected');
            
            // æ˜¾ç¤ºæ•°æ®åº“æ¦‚è§ˆ
            showDatabaseOverview();
        }

        // é€‰æ‹©è¡¨
        async function selectTable(tableName) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.db-tree-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.db-tree-item').classList.add('selected');
            
            // æ˜¾ç¤ºè¡¨è¯¦æƒ…
            await showTableDetails(tableName);
        }

        // æ˜¾ç¤ºæ•°æ®åº“æ¦‚è§ˆ
        function showDatabaseOverview() {
            const detailsContent = document.getElementById('details-content');
            const tables = document.querySelectorAll('.tree-children .db-tree-item');
            
            detailsContent.innerHTML = `
                <div class="table-info-card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i>
                        æ•°æ®åº“ç»Ÿè®¡
                    </div>
                    <div class="card-content">
                        <div class="table-wrapper">
                            <table class="modern-table">
                                <tbody>
                                    <tr>
                                        <td style="font-weight: 600;">è¡¨æ€»æ•°</td>
                                        <td>${tables.length}</td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: 600;">æ•°æ®åº“å¼•æ“</td>
                                        <td>SQLite</td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: 600;">å­—ç¬¦é›†</td>
                                        <td>UTF-8</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="table-info-card">
                    <div class="card-header">
                        <i class="fas fa-list"></i>
                        è¡¨åˆ—è¡¨
                    </div>
                    <div class="card-content">
                        <div class="table-wrapper">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>è¡¨å</th>
                                        <th>è®°å½•æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array.from(tables).map(table => {
                                        const tableName = table.querySelector('.tree-label').textContent;
                                        const rowCount = table.querySelector('.tree-meta').textContent;
                                        return `
                                            <tr>
                                                <td>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <div class="tree-icon table" style="width: 16px; height: 16px; font-size: 10px;">
                                                            <i class="fas fa-table"></i>
                                                        </div>
                                                        ${tableName}
                                                    </div>
                                                </td>
                                                <td>${rowCount}</td>
                                                <td>
                                                    <button class="toolbar-btn" onclick="selectTable('${tableName}')" style="padding: 4px 8px; font-size: 11px;">
                                                        æŸ¥çœ‹è¯¦æƒ…
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºè¡¨è¯¦æƒ…
        async function showTableDetails(tableName) {
            const detailsContent = document.getElementById('details-content');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            detailsContent.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i><br/>
                    æ­£åœ¨åŠ è½½è¡¨ ${tableName} çš„è¯¦ç»†ä¿¡æ¯...
                </div>
            `;
            
            try {
                // å¹¶è¡ŒåŠ è½½è¡¨å­—æ®µå’Œæ•°æ®
                const [columnsResponse, dataResponse] = await Promise.all([
                    fetch(`/api/table/${tableName}/columns`),
                    fetch(`/api/table/${tableName}/data?limit=10`)
                ]);
                
                const columnsData = await columnsResponse.json();
                const tableData = await dataResponse.json();
                
                if (columnsData.success) {
                    renderTableDetails(tableName, columnsData.columns, tableData);
                } else {
                    detailsContent.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #d32f2f;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px;"></i><br/>
                            ${columnsData.error || 'åŠ è½½è¡¨ä¿¡æ¯å¤±è´¥'}
                        </div>
                    `;
                }
            } catch (error) {
                detailsContent.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #d32f2f;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 16px;"></i><br/>
                        åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è¡¨è¯¦ç»†ä¿¡æ¯ï¼ˆæ ‡ç­¾é¡µç‰ˆæœ¬ï¼‰
        function renderTableDetails(tableName, columns, tableData) {
            const detailsContent = document.getElementById('details-content');
            
            // ç”Ÿæˆè¡¨ç»“æ„HTML
            const structureHtml = `
                <div class="table-info-card">
                    <div class="card-header">
                        <i class="fas fa-columns"></i>
                        è¡¨ç»“æ„
                    </div>
                    <div class="card-content">
                        <div class="table-wrapper">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>å­—æ®µå</th>
                                        <th>æ•°æ®ç±»å‹</th>
                                        <th>é”®ç±»å‹</th>
                                        <th>å…è®¸NULL</th>
                                        <th>é»˜è®¤å€¼</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${columns.map(column => {
                                        const typeClass = getTypeClass(column.type);
                                        const keyBadge = getKeyBadge(column.key);
                                        
                                        return `
                                            <tr>
                                                <td>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <div class="tree-icon ${column.key === 'PRI' ? 'primary-key' : 'column'}" style="width: 16px; height: 16px; font-size: 10px;">
                                                            <i class="fas ${column.key === 'PRI' ? 'fa-key' : 'fa-minus'}"></i>
                                                        </div>
                                                        <span style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-weight: 500;">${column.name || column.field}</span>
                                                    </div>
                                                </td>
                                                <td><span class="type-badge ${typeClass}">${column.type}</span></td>
                                                <td>${keyBadge}</td>
                                                <td>${column.null === 'YES' ? 'âœ“' : 'âœ—'}</td>
                                                <td>${column.default || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // ç”Ÿæˆæ•°æ®é¢„è§ˆHTML
            let dataHtml = '';
            if (tableData.success && tableData.columns && tableData.rows) {
                dataHtml = `
                    <div class="table-info-card">
                        <div class="card-header">
                            <i class="fas fa-table"></i>
                            è¡¨æ•°æ® (å‰ ${tableData.rows.length} è¡Œ)
                        </div>
                        <div class="card-content">
                            ${tableData.rows.length > 0 ? `
                                <div class="table-wrapper">
                                    <table class="modern-table">
                                        <thead>
                                            <tr>
                                                ${tableData.columns.map(col => `<th>${col}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableData.rows.map(row => `
                                                <tr>
                                                    ${row.map(cell => {
                                                        const cellValue = cell === null ? '<em style="color: #94a3b8;">NULL</em>' : 
                                                                        cell === '' ? '<em style="color: #94a3b8;">(ç©º)</em>' : 
                                                                        String(cell);
                                                        const displayValue = String(cellValue).length > 50 ? 
                                                                            String(cellValue).substring(0, 50) + '...' : cellValue;
                                                        return `<td title="${cell || ''}">${displayValue}</td>`;
                                                    }).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="empty-state" style="padding: 40px;">
                                    <i class="fas fa-inbox"></i>
                                    <h3>æš‚æ— æ•°æ®</h3>
                                    <p>è¯¥è¡¨ä¸­æ²¡æœ‰ä»»ä½•è®°å½•</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } else {
                dataHtml = `
                    <div class="empty-state" style="padding: 40px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>æ•°æ®åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è·å–è¡¨æ•°æ®</p>
                    </div>
                `;
            }
            
            // åˆ›å»ºæ ‡ç­¾é¡µç•Œé¢
            detailsContent.innerHTML = `
                <div class="details-tabs">
                    <button class="tab-btn active" onclick="switchTab('data')">
                        <i class="fas fa-table"></i> è¡¨æ•°æ®
                    </button>
                    <button class="tab-btn" onclick="switchTab('structure')">
                        <i class="fas fa-columns"></i> è¡¨ç»“æ„
                    </button>
                </div>
                <div class="tab-content active" id="tab-data">
                    ${dataHtml}
                </div>
                <div class="tab-content" id="tab-structure">
                    ${structureHtml}
                </div>
            `;
        }

        // ç»“æœæ˜¾ç¤ºæ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
        function switchTab(tabType) {
            try {
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // æ‰¾åˆ°è¢«ç‚¹å‡»çš„æŒ‰é’®å¹¶æ¿€æ´»
                const clickedBtn = event && event.target ? event.target.closest('.tab-btn') : null;
                if (clickedBtn) {
                    clickedBtn.classList.add('active');
                }
                
                // æ›´æ–°å†…å®¹æ˜¾ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const targetContent = document.getElementById(`tab-${tabType}`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            } catch (error) {
                console.error('ç»“æœæ ‡ç­¾é¡µåˆ‡æ¢å¤±è´¥:', error);
            }
        }

        // è·å–æ•°æ®ç±»å‹å¯¹åº”çš„æ ·å¼ç±»
        function getTypeClass(type) {
            const lowerType = type.toLowerCase();
            if (lowerType.includes('int') || lowerType.includes('float') || lowerType.includes('double') || lowerType.includes('decimal')) {
                return 'number';
            } else if (lowerType.includes('date') || lowerType.includes('time')) {
                return 'date';
            } else {
                return 'string';
            }
        }

        // è·å–é”®ç±»å‹æ ‡ç­¾
        function getKeyBadge(key) {
            if (key === 'PRI') {
                return '<span class="key-badge primary"><i class="fas fa-key"></i> ä¸»é”®</span>';
            } else if (key === 'MUL') {
                return '<span class="key-badge index"><i class="fas fa-search"></i> ç´¢å¼•</span>';
            } else {
                return '-';
            }
        }

        // åˆ·æ–°æ•°æ®åº“ç»“æ„
        async function refreshSchema() {
            await showSchema();
        }

        // æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
        async function showModels() {
            console.log('=== showModelså‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
            
            try {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†å’ŒåŠ è½½çŠ¶æ€
                showModal('models-modal');
                document.getElementById('models-content').innerHTML = 'åŠ è½½ä¸­...';
                console.log('æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼Œå¼€å§‹è·å–æ¨¡å‹æ•°æ®...');
                
                const response = await fetch('/api/models');
                console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('APIè¿”å›çš„å®Œæ•´æ•°æ®:', JSON.stringify(data, null, 2));
                
                if (data.success && data.models && Array.isArray(data.models)) {
                    let html = `
                        <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <strong>åç«¯ç±»å‹:</strong> ${data.backend || 'æœªçŸ¥'}<br/>
                            <strong>å½“å‰æ¨¡å‹:</strong> ${data.current || 'æœªçŸ¥'}<br/>
                            <strong>æ¨¡å‹æ€»æ•°:</strong> ${data.models.length}
                        </div>
                        <h4 style="margin-bottom: 12px;">å¯ç”¨æ¨¡å‹åˆ—è¡¨:</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                    `;
                    
                    data.models.forEach((model, index) => {
                        const isCurrent = model === data.current;
                        html += `
                            <div style="
                                padding: 12px; 
                                margin: 4px 0; 
                                border: 1px solid #e0e0e0; 
                                border-radius: 6px;
                                background: ${isCurrent ? '#e3f2fd' : '#ffffff'};
                                ${isCurrent ? 'border-color: #2196f3; font-weight: 600;' : ''}
                            ">
                                ${model} ${isCurrent ? '<span style="color: #2196f3;">(å½“å‰ä½¿ç”¨)</span>' : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    console.log('å‡†å¤‡è®¾ç½®HTMLå†…å®¹...');
                    document.getElementById('models-content').innerHTML = html;
                    console.log('HTMLå†…å®¹å·²è®¾ç½®å®Œæˆ');
                    
                } else {
                    console.error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
                    document.getElementById('models-content').innerHTML = `
                        <div style="color: red; padding: 16px; background: #ffebee; border-radius: 8px;">
                            <h4>âŒ è·å–æ¨¡å‹ä¿¡æ¯å¤±è´¥</h4>
                            <p><strong>åŸå› :</strong> ${data.error || 'æ•°æ®æ ¼å¼ä¸æ­£ç¡®'}</p>
                            <details style="margin-top: 10px;">
                                <summary>è°ƒè¯•ä¿¡æ¯</summary>
                                <pre style="background: #f5f5f5; padding: 10px; margin-top: 10px; overflow: auto;">
${JSON.stringify(data, null, 2)}
                                </pre>
                            </details>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('showModelså‡½æ•°æ‰§è¡Œå¤±è´¥:', error);
                document.getElementById('models-content').innerHTML = `
                    <div style="color: red; padding: 16px; background: #ffebee; border-radius: 8px;">
                        <h4>âŒ è¿æ¥å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p><strong>å»ºè®®:</strong> è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                    </div>
                `;
            }
            
            console.log('=== showModelså‡½æ•°æ‰§è¡Œå®Œæˆ ===');
        }

        // é‡æ–°åˆå§‹åŒ–
        async function reinitialize() {
            try {
                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        backend: 'ollama',
                        model: 'qwen2'
                    }),
                });

                const data = await response.json();
                
                if (data.success) {
                    checkStatus();
                    showSuccess('ç³»ç»Ÿé‡æ–°åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('é‡æ–°åˆå§‹åŒ–å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                    ${escapeHtml(message)}
                </div>
            `;
            
            resultsSection.classList.remove('hidden');
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // è½¬ä¹‰HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // å¿«é€Ÿåˆ‡æ¢åˆ°é€šä¹‰åƒé—®
        async function switchToQwen() {
            console.log('åˆ‡æ¢åˆ°é€šä¹‰åƒé—®...');
            
            // æ›´æ–°é…ç½®UI
            document.getElementById('backend-select').value = 'qwen_api';
            document.getElementById('model-select').value = 'qwen-plus';
            updateModelOptions(); // æ›´æ–°æ¨¡å‹åˆ—è¡¨
            
            // æ˜¾ç¤ºAPI Keyè¾“å…¥æ¡†
            updateApiKeyVisibility();
            
            // æç¤ºç”¨æˆ·
            showSuccess('å·²åˆ‡æ¢åˆ°é€šä¹‰åƒé—®åç«¯ï¼Œè¯·è®¾ç½®API Keyåé‡æ–°åˆå§‹åŒ–');
            
            // æ»šåŠ¨åˆ°é…ç½®åŒºåŸŸ
            document.getElementById('config-section').scrollIntoView({ behavior: 'smooth' });
        }

        // å›è½¦é”®æ‰§è¡ŒæŸ¥è¯¢
        document.getElementById('query-input').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
            }
        });

        // ========== è¡¨é€‰æ‹©å™¨åŠŸèƒ½ï¼ˆæ¨¡æ€æ¡†ç‰ˆæœ¬ï¼‰ ==========
        let selectedTables = new Set(); // ä½¿ç”¨Setå­˜å‚¨é€‰ä¸­çš„è¡¨
        let allTablesData = []; // å­˜å‚¨æ‰€æœ‰è¡¨çš„æ•°æ®

        // æ˜¾ç¤ºè¡¨ç»“æ„æ¨¡æ€æ¡†
        async function showTablesModal() {
            console.log('æ˜¾ç¤ºè¡¨ç»“æ„æ¨¡æ€æ¡†...');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            showModal('tables-modal');
            
            // åŠ è½½è¡¨ç»“æ„æ•°æ®
            try {
                document.getElementById('tables-content').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                        <p style="margin-top: 16px; color: #666;">æ­£åœ¨åŠ è½½è¡¨ç»“æ„...</p>
                    </div>
                `;
                
                const response = await fetch('/api/tables');
                const data = await response.json();
                
                if (data.success && data.tables) {
                    renderTablesModal(data.tables);
                } else {
                    document.getElementById('tables-content').innerHTML = `
                        <div style="color: red; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <p>è·å–è¡¨ç»“æ„å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è·å–è¡¨ç»“æ„å¤±è´¥:', error);
                document.getElementById('tables-content').innerHTML = `
                    <div style="color: red; text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>è¿æ¥å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è¡¨ç»“æ„åˆ°æ¨¡æ€æ¡†ï¼ˆå¸¦é€‰æ‹©åŠŸèƒ½ï¼‰
        function renderTablesModal(tables) {
            if (!tables || tables.length === 0) {
                document.getElementById('tables-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-database" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>æœªæ‰¾åˆ°ä»»ä½•è¡¨</p>
                    </div>
                `;
                return;
            }

            // ä¿å­˜è¡¨æ•°æ®
            allTablesData = tables;

            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="color: #666;">
                            å…±æ‰¾åˆ° <strong style="color: var(--primary-color);">${tables.length}</strong> ä¸ªè¡¨
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="button secondary" onclick="selectAllTablesModal()" style="font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-check-double"></i> å…¨é€‰
                            </button>
                            <button class="button secondary" onclick="clearAllTablesModal()" style="font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-times"></i> æ¸…ç©º
                            </button>
                        </div>
                    </div>
                    
                    <div id="selected-tables-info-modal" style="font-size: 14px; color: #666; margin-bottom: 16px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                        å·²é€‰æ‹© <span id="selected-count-modal">${selectedTables.size}</span> ä¸ªè¡¨
                        <span style="color: #999; font-size: 12px; margin-left: 8px;">
                            (${selectedTables.size > 0 ? 'å°†åªåœ¨è¿™äº›è¡¨ä¸­æŸ¥è¯¢' : 'æœªé€‰æ‹©æ—¶ä½¿ç”¨æ‰€æœ‰è¡¨'})
                        </span>
                    </div>
                </div>
                
                <div class="tables-grid" style="max-height: 400px; overflow-y: auto;">
            `;

            tables.forEach(table => {
                const isSelected = selectedTables.has(table.name);
                const columnsPreview = table.columns.slice(0, 5).join(', ') + (table.column_count > 5 ? ` ... (+${table.column_count - 5}ä¸ª)` : '');
                
                html += `
                    <div class="table-item ${isSelected ? 'selected' : ''}" onclick="toggleTableModal('${table.name}')" 
                         style="margin-bottom: 12px; border: 2px solid ${isSelected ? 'var(--primary-color)' : '#e5e7eb'}; 
                                border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s ease;
                                background: ${isSelected ? 'rgba(52, 152, 219, 0.05)' : 'white'};">
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: ${isSelected ? '#f0f8ff' : '#f8fafc'};">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                       onchange="event.stopPropagation(); toggleTableModal('${table.name}')"
                                       style="margin-right: 12px; transform: scale(1.2);">
                                <h4 style="margin: 0; color: #1e293b; display: flex; align-items: center; flex: 1;">
                                    <i class="fas fa-table" style="margin-right: 8px; color: var(--primary-color);"></i>
                                    ${table.name}
                                    <span style="margin-left: auto; font-size: 12px; color: #64748b; font-weight: normal;">
                                        ${table.column_count} ä¸ªå­—æ®µ
                                    </span>
                                </h4>
                            </div>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                <i class="fas fa-list" style="margin-right: 4px;"></i>
                                å­—æ®µé¢„è§ˆ: ${columnsPreview}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 6px; max-height: 120px; overflow-y: auto;">
                `;
                
                table.columns.forEach(column => {
                    html += `
                        <div style="background: #f1f5f9; padding: 6px 8px; border-radius: 4px; font-size: 11px;">
                            <strong style="color: #334155;">${column}</strong>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('tables-content').innerHTML = html;
        }

        // æ¨¡æ€æ¡†ä¸­çš„è¡¨é€‰æ‹©æ“ä½œ
        function toggleTableModal(tableName) {
            if (selectedTables.has(tableName)) {
                selectedTables.delete(tableName);
            } else {
                selectedTables.add(tableName);
            }
            renderTablesModal(allTablesData); // é‡æ–°æ¸²æŸ“
            updateTablesButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
        }

        function selectAllTablesModal() {
            selectedTables.clear();
            allTablesData.forEach(table => {
                selectedTables.add(table.name);
            });
            renderTablesModal(allTablesData);
            updateTablesButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
        }

        function clearAllTablesModal() {
            selectedTables.clear();
            renderTablesModal(allTablesData);
            updateTablesButton(); // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
        }

        // è·å–é€‰ä¸­çš„è¡¨åˆ—è¡¨ï¼ˆä¾›æŸ¥è¯¢æ—¶ä½¿ç”¨ï¼‰
        function getSelectedTables() {
            return selectedTables.size > 0 ? Array.from(selectedTables) : null;
        }

        // æ›´æ–°è¡¨é€‰æ‹©æŒ‰é’®æ˜¾ç¤º
        function updateTablesButton() {
            const btn = document.getElementById('tables-btn');
            const text = document.getElementById('tables-btn-text');
            const count = document.getElementById('tables-count');
            
            if (selectedTables.size > 0) {
                text.textContent = 'å·²é€‰è¡¨ç»“æ„';
                count.textContent = selectedTables.size;
                count.style.display = 'inline';
                btn.style.borderColor = 'var(--primary-color)';
                btn.style.background = 'rgba(52, 152, 219, 0.1)';
            } else {
                text.textContent = 'é€‰æ‹©è¡¨ç»“æ„';
                count.style.display = 'none';
                btn.style.borderColor = '';
                btn.style.background = '';
            }
        }

        // ä»config.iniåŠ è½½API Keyåˆ°å‰ç«¯é…ç½®åŒºåŸŸ
        async function loadApiKeyFromConfig() {
            try {
                const response = await fetch('/api/get-model-config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const apiKeyInput = document.getElementById('api-key-input');
                    if (apiKeyInput && data.config.api_key) {
                        apiKeyInput.value = data.config.api_key;
                        console.log('âœ… API Keyå·²ä»config.iniåŠ è½½åˆ°å‰ç«¯');
                    }
                    
                    // åŒæ—¶æ›´æ–°API Keyæ˜¾ç¤ºçŠ¶æ€
                    updateApiKeyVisibility();
                }
            } catch (error) {
                console.error('åŠ è½½API Keyé…ç½®å¤±è´¥:', error);
            }
        }

    </script>

    <!-- è¡¨ç»“æ„æ¨¡æ€æ¡† -->
    <div id="tables-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closeModal('tables-modal')"></div>
        <div class="modal-content" style="max-width: 900px; max-height: 85vh;">
            <div class="modal-header">
                <h3><i class="fas fa-table"></i> é€‰æ‹©æŸ¥è¯¢è¡¨èŒƒå›´</h3>
                <button class="modal-close" onclick="closeModal('tables-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="tables-content">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                        <p style="margin-top: 16px; color: #666;">æ­£åœ¨åŠ è½½è¡¨ç»“æ„...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html> 